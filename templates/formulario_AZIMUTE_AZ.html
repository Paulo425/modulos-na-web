@app.route('/memorial_azimute_az', methods=['GET', 'POST'])
def gerar_memorial_azimute_az():
    if 'usuario' not in session:
        return redirect(url_for('login'))

    if request.method == 'POST':
        diretorio = os.path.join(BASE_DIR, 'tmp', 'CONCLUIDO')
        cidade = request.form['cidade']
        arquivo_excel = request.files['excel']
        arquivo_dxf = request.files['dxf']

        os.makedirs(diretorio, exist_ok=True)

        caminho_excel = os.path.join(app.config['UPLOAD_FOLDER'], arquivo_excel.filename)
        caminho_dxf = os.path.join(app.config['UPLOAD_FOLDER'], arquivo_dxf.filename)
        arquivo_excel.save(caminho_excel)
        arquivo_dxf.save(caminho_dxf)

        log_filename = datetime.now().strftime("log_AZIMUTEAZ_%Y%m%d_%H%M%S.log")
        log_dir_absoluto = os.path.join(BASE_DIR, "static", "logs")
        os.makedirs(log_dir_absoluto, exist_ok=True)

        log_path = os.path.join(log_dir_absoluto, log_filename)
        log_relativo = f"static/logs/{log_filename}"

        try:
            processo = Popen(
                ["python", os.path.join(BASE_DIR, "executaveis_azimute_az", "main.py"), cidade, caminho_excel, caminho_dxf],
                stdout=PIPE,
                stderr=subprocess.STDOUT,
                text=True
            )

            log_lines = []
            with open(log_path, 'w', encoding='utf-8') as log_file:
                for linha in processo.stdout:
                    if len(log_lines) < 60:
                        log_file.write(linha)
                        log_lines.append(linha)
                    print("üñ®Ô∏è", linha.strip())

            processo.wait()

            if processo.returncode == 0:
                session['resultado'] = "‚úÖ Processamento conclu√≠do com sucesso!"
            else:
                session['erro_execucao'] = f"‚ùå Erro na execu√ß√£o:<br><pre>{''.join(log_lines)}</pre>"

        except Exception as e:
            session['erro_execucao'] = f"‚ùå Erro inesperado:<br><pre>{type(e).__name__}: {str(e)}</pre>"

        finally:
            os.remove(caminho_excel)
            os.remove(caminho_dxf)

        try:
            arquivos_zip = [f for f in os.listdir(diretorio) if f.lower().endswith('.zip')]
            if arquivos_zip:
                arquivos_zip.sort(key=lambda x: os.path.getmtime(os.path.join(diretorio, x)), reverse=True)
                zip_download = arquivos_zip[0]
                origem_zip = os.path.join(diretorio, zip_download)
                destino_zip = os.path.join(BASE_DIR, 'tmp', 'CONCLUIDO', zip_download)
                shutil.copy(origem_zip, destino_zip)
                session['zip_download'] = zip_download
        except Exception as e:
            print(f"‚ö†Ô∏è Erro ao localizar ou copiar arquivo ZIP: {e}")

        session['log_path'] = log_relativo
        return redirect(url_for('memoriais_azimute_az'))

    # GET request - recupera dados da sess√£o
    resultado = session.pop('resultado', None)
    erro_execucao = session.pop('erro_execucao', None)
    zip_download = session.pop('zip_download', None)
    log_relativo = session.pop('log_path', None)

    return render_template("formulario_AZIMUTE_AZ.html", resultado=resultado, erro=erro_execucao, zip_download=zip_download, log_path=log_relativo)
