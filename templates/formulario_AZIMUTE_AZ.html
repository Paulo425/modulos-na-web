{% extends 'base.html' %}

{% block conteudo %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="text-primary">Gerar Memorial AZIMUTE AZ</h2>
        <div class="d-flex gap-2 align-items-center">
            <span class="text-muted me-2">üë§ {{ session['usuario'] }}</span>
            {% if log_path %}
            <a href="/{{ log_path }}" class="btn btn-outline-secondary" download>
                üßæ Baixar Log da Execu√ß√£o
            </a>
            {% endif %}
            <a href="/logout" class="btn btn-outline-danger">üîí Logout</a>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" onsubmit="document.getElementById('spinner').style.display='block'">
        <div class="mb-3">

            <div class="form-check form-switch mb-4">
                <input class="form-check-input" type="checkbox" id="sentidoPoligonal" name="sentidoPoligonal" value="anti_horario">
                <label class="form-check-label text-primary" for="sentidoPoligonal">
                    üîÑ Sentido da Poligonal: <strong id="labelSentido">Hor√°rio (direita)</strong>
                </label>
            </div>

            <script>
            document.getElementById('sentidoPoligonal').addEventListener('change', function() {
                document.getElementById('labelSentido').innerHTML = this.checked ? "Anti-hor√°rio (esquerda)" : "Hor√°rio (direita)";
            });
            </script>




            <label for="cidade" class="form-label">Cidade:</label>
            <input type="text" class="form-control" id="cidade" name="cidade" required>
        </div>

        <div class="mb-3">
            <label for="excel" class="form-label">Arquivo Excel:</label>
            <div class="input-group">
                <input type="file" class="form-control" name="excel" id="excel" accept=".xlsx" required>
                <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoExcel">
                    ‚ÑπÔ∏è
                </button>
            </div>
            <div class="collapse mt-1" id="infoExcel">
                <div class="alert alert-secondary">
                    Deve conter a aba <strong>Dados_do_Im√≥vel</strong> e uma aba com os confrontantes, como <strong>Confrontantes_Servidao</strong>.<br>
                    As colunas devem ser: <strong>C√≥digo</strong> e <strong>Confrontante</strong> com valores do tipo <code>V1, V2, ..., Vn</code>.
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="dxf" class="form-label">Arquivo DXF:</label>
            <div class="input-group">
                <input type="file" class="form-control" name="dxf" id="dxf" accept=".dxf" required>
                <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoDxf">
                    ‚ÑπÔ∏è
                </button>
            </div>
            <div class="collapse mt-1" id="infoDxf">
                <div class="alert alert-secondary">
                    O nome deve conter o tipo e matr√≠cula (Ex: <code>SER_Mat_12345.dxf</code>).<br>
                    O DXF deve estar no formato 2010 e conter uma √∫nica polilinha fechada com o ponto Az inserido.
                </div>
            </div>
        </div>

        <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Executar</button>
        </div>
    </form>

    <div id="spinner" class="text-center mt-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Processando...</span>
        </div>
        <p class="mt-2">Aguarde. Gerando arquivos...</p>
    </div>

    <hr>

    {% if resultado %}
    <div class="alert alert-success mt-4 text-center">
        {{ resultado | safe }}
    </div>
    {% endif %}
    {#
    {% if zip_download %}
        <p style="text-align: center; color: darkgreen;">
            üß™ DEBUG: Nome do ZIP ‚Üí <strong>{{ zip_download }}</strong>
        </p>
    {% else %}
        <p style="text-align: center; color: red;">
            ‚ùå DEBUG: Nenhum ZIP detectado
        </p>
    {% endif %}
    #}
    {% if erro and not success %}
        <div class="alert alert-danger mt-4 text-center">{{ erro|safe }}</div>
    {% endif %}


    {#	
    <p class="text-center text-primary">
        üîç Valor de zip_download: <strong>{{ zip_download }}</strong>
    </p>
    #}

   
    <div class="mt-4 text-center">
        {# ZIP s√≥ quando houve sucesso #}
        {% if success and zip_url %}
            <a class="btn btn-success btn-lg" href="{{ zip_url }}">üì¶ Baixar ZIP</a>
        {% elif success and zip_urls %}
            <div class="d-flex flex-wrap gap-2 justify-content-center">
            {% for z in zip_urls %}
                <a class="btn btn-success" href="{{ z }}">üì¶ {{ z.split('/')[-1] }}</a>
            {% endfor %}
            </div>
        {% endif %}

        {# LOG: sempre que houver URL do log #}
        {% if log_path %}
            <a class="btn btn-outline-secondary ms-2" href="{{ log_path }}">
            üßæ Baixar Log da Execu√ß√£o
            </a>
        {% endif %}

        {# Mensagem de erro quando n√£o houve sucesso #}
        {% if not success and erro %}
            <div class="alert alert-warning mt-3">{{ erro }}</div>
        {% endif %}
    </div>





</div>
{% endblock %}

