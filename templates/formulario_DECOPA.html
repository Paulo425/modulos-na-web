{% extends 'base.html' %}

{% block conteudo %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="text-primary">Gerar Memorial Descritivo</h2>
        <div class="d-flex gap-2 align-items-center">
            <span class="text-muted me-2">üë§ {{ session['usuario'] }}</span>
            {% if log_path %}
            <a href="{{ log_path }}" class="btn btn-outline-secondary" download>
                üßæ Baixar Log da Execu√ß√£o
            </a>

            {% endif %}
            <a href="/logout" class="btn btn-outline-danger">üîí Logout</a>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" onsubmit="document.getElementById('spinner').style.display='block'">
        <div class="mb-3">


            <div class="form-check form-switch mb-4">
                <input class="form-check-input" type="checkbox" id="sentidoPoligonal" name="sentidoPoligonal" value="anti_horario">
                <label class="form-check-label text-primary" for="sentidoPoligonal">
                    üîÑ Sentido da Poligonal: <strong id="labelSentido">Hor√°rio (direita)</strong>
                </label>
            </div>

            <script>
            document.getElementById('sentidoPoligonal').addEventListener('change', function() {
                document.getElementById('labelSentido').innerHTML = this.checked ? "Anti-hor√°rio (esquerda)" : "Hor√°rio (direita)";
            });
            </script>


            <label for="diretorio" class="form-label">Cidade:</label>
            <input type="text" class="form-control" name="cidade" id="cidade" required>
        </div>

        <div class="mb-3">
            <label for="excel" class="form-label">Arquivo Excel:</label>
            <div class="input-group">
                <input type="file" class="form-control" name="excel" id="excel" accept=".xlsx" required>
                <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoExcel">
                    ‚ÑπÔ∏è
                </button>
            </div>
            <div class="collapse mt-1" id="infoExcel">
                <div class="alert alert-secondary">
                    No nome do arquivo tem que ter o n√∫mero da matr√≠cula (Ex: <code>Porto_Alegre_Mat_33333.xlsx</code>).<br>
                    As abas devem se chamar: <strong>Dados_do_Im√≥vel</strong>, <strong>ETE</strong>, <strong>Confrontantes_Remanescente</strong>, <strong>Confrontantes_Servid√£o</strong>, <strong>Confrontantes_Acesso</strong>.<br>
                    Cada aba deve ter as colunas <strong>C√≥digo</strong> e <strong>Confrontante</strong>, com os valores <code>V1, V2, ..., Vn</code> e o nome dos confrontantes.
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="dxf" class="form-label">Arquivo DXF:</label>
            <div class="input-group">
                <input type="file" class="form-control" name="dxf" id="dxf" accept=".dxf" required>
                <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoDxf">
                    ‚ÑπÔ∏è
                </button>
            </div>
            <div class="collapse mt-1" id="infoDxf">
                <div class="alert alert-secondary">
                    O nome deve conter o tipo e matr√≠cula (Ex: <code>ETE_Mat_33333.dxf</code> ou <code>REM_Mat_33333.dxf</code>).<br>
                    O DXF deve estar no formato 2010, contendo apenas o desenho geom√©trico da poligonal alvo, sem r√≥tulos ou textos.
                </div>
            </div>
        </div>

        <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Executar</button>
        </div>
    </form>

    <div id="spinner" class="text-center mt-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Processando...</span>
        </div>
        <p class="mt-2">Aguarde. Gerando arquivos...</p>
    </div>

    <hr>

    {% if resultado %}
    <div class="alert alert-success mt-4 text-center">
        {{ resultado | safe }}
    </div>
    {% endif %}

    {% if erro %}
    <div class="alert alert-danger mt-4">
        {{ erro | safe }}
    </div>
    {% endif %}

    {% if success and zip_urls %}
    <div class="text-center mt-4">
        {% if zip_urls|length == 1 %}
        <a href="{{ zip_urls[0] }}" class="btn btn-success" download>üì¶ Baixar ZIP Gerado</a>
        {% else %}
        <div class="d-grid gap-2">
            {% for z in zip_urls %}
            <a href="{{ z }}" class="btn btn-success" download>üì¶ Baixar ZIP {{ loop.index }}</a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% elif zip_download and run_uuid %}
    <div class="text-center mt-4">
        <a href="{{ url_for('download_zip_decopa', uuid=run_uuid, fname=zip_download) }}" class="btn btn-success" download>
        üì¶ Baixar ZIP Gerado
        </a>
    </div>
    {% endif %}



</div>
{% endblock %}

